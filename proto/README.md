# Protobuf 和 gRPC 版本管理

## 版本固定策略

本项目使用严格的版本管理以确保 ABI 兼容性和构建可重现性。

### 当前固定版本

| 依赖 | 版本 | 固定位置 |
|------|------|----------|
| protobuf | 4.25.x | `vcpkg.json`, `proto/buf.yaml`, `buf.gen.yaml` |
| gRPC | 1.71.x | `vcpkg.json`, `proto/buf.yaml`, `buf.gen.yaml` |

### 版本固定文件

#### 1. `vcpkg.json` - C++ 库依赖
```json
{
  "name": "protobuf",
  "version>=": "4.25.1",
  "version<": "4.26.0"
}
```
固定 vcpkg 安装的 protobuf 编译库版本。

#### 2. `proto/buf.yaml` - Buf 依赖管理
```yaml
deps:
  - buf.build/google/protobuf:v25.1
  - buf.build/grpc/grpc:v1.71.0
```
固定 buf 工具拉取的 protobuf 和 gRPC 模块版本。

#### 3. `buf.gen.yaml` - 代码生成插件
```yaml
plugins:
  - remote: buf.build/protocolbuffers/cpp:v25.1
  - remote: buf.build/grpc/cpp:v1.71.0
```
固定用于生成 C++ 代码的插件版本，确保生成的代码与编译库版本兼容。

## 版本兼容性

### Protobuf 版本对应关系

| Buf 标签 | vcpkg 版本 | 说明 |
|----------|------------|------|
| v25.1 | 4.25.x | 当前使用版本 |
| v26.x | 4.26.x | 不兼容 ABI |

**重要**: protobuf 4.25.x 和 4.26.x 之间有 ABI 破坏性变更，必须确保所有组件使用相同的次版本号。

### 版本升级流程

当需要升级 protobuf/gRPC 版本时，必须同时更新以下三个文件：

1. **vcpkg.json** - 更新 `version>=` 和 `version<` 约束
2. **proto/buf.yaml** - 更新 `deps` 中的版本标签
3. **buf.gen.yaml** - 更新 `plugins` 中的版本标签

**示例 - 升级到 4.26.x**:
```bash
# 1. 更新 vcpkg.json
"version>=": "4.26.0"
"version<": "4.27.0"

# 2. 更新 proto/buf.yaml
- buf.build/google/protobuf:v26.0
- buf.build/grpc/grpc:v1.72.0  # 检查兼容的 gRPC 版本

# 3. 更新 buf.gen.yaml
- remote: buf.build/protocolbuffers/cpp:v26.0
- remote: buf.build/grpc/cpp:v1.72.0

# 4. 重新生成 proto 代码
cd proto && buf generate

# 5. 清理并重新构建
rm -rf build && cmake -B build ...
```

## 验证版本一致性

### 检查编译的库版本
```bash
# 检查 vcpkg 安装的 protobuf 版本
vcpkg list protobuf

# 检查链接的库版本 (Linux/macOS)
otool -L build/bin/croupier-example | grep protobuf
ldd build/bin/croupier-example | grep libprotobuf
```

### 检查生成的代码版本
生成的 proto 文件头部包含版本信息：
```cpp
// Generated by the protocol buffer compiler.  DO NOT EDIT!
// source: croupier/sdk/v1/client.proto
// Protobuf version: 4.25.1
```

## 常见问题

### Q: 为什么需要固定三个地方的版本？

**A**: 不同工具链组件：
- **vcpkg.json**: C++ 编译时链接的库版本
- **buf.yaml**: Proto 文件语法检查和依赖解析
- **buf.gen.yaml**: 代码生成器版本，生成的代码必须与编译库 ABI 兼容

### Q: 版本不匹配会怎样？

**A**: 可能导致：
- 链接错误：undefined reference to protobuf 符号
- 运行时崩溃：ABI 不兼容导致内存访问错误
- 序列化失败：不同版本间的数据格式变化

### Q: 如何确保 CI/CD 使用正确版本？

**A**: CI 配置中：
1. 使用固定的 vcpkg commit ID（在 `.github/workflows/nightly.yml` 中）
2. 依赖 `vcpkg.json` 的版本约束
3. CI 环境中 buf 工具会自动读取 `proto/buf.yaml` 和 `buf.gen.yaml`

## 相关链接

- [vcpkg 版本控制](https://learn.microsoft.com/en-us/vcpkg/users/versioning)
- [Buf 版本管理](https://buf.build/docs/reference/configuration)
- [Protobuf 版本兼容性](https://protobuf.dev/support/version-support/)
