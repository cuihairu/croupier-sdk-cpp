name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Code quality checks (format + static analysis)
  code-quality:
    runs-on: ubuntu-latest
    continue-on-error: true  # 仅警告，不阻止合并

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-17 clang-tidy-17
        sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-17 100
        sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-17 100

    - name: Check code formatting
      run: |
        echo "::group::Checking code formatting with clang-format"
        find src include examples tests -name '*.cpp' -o -name '*.h' | head -100 | while read file; do
          if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
            echo "::warning file=$file::Code formatting issues detected"
          fi
        done
        echo "::endgroup::"

    - name: Run clang-format diff
      run: |
        echo "Files with formatting differences:"
        find src include examples tests -name '*.cpp' -o -name '*.h' | head -100 | xargs -I {} sh -c 'diff -u {} <(clang-format {}) || true' 2>/dev/null | head -200 || true

    - name: Run clang-tidy (basic checks)
      run: |
        echo "::group::Running clang-tidy static analysis"
        # 只检查主要源文件，跳过生成的代码
        for file in src/*.cpp src/**/*.cpp; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
            clang-tidy "$file" \
              --checks='-*,bugprone-*,clang-analyzer-*,performance-*,modernize-use-nullptr,modernize-use-override' \
              --quiet \
              -- -std=c++17 -I include -I src 2>/dev/null || echo "::warning file=$file::clang-tidy found issues"
          fi
        done
        echo "::endgroup::"

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许一个构建失败时其他继续
      max-parallel: 1   # 串行构建避免 vcpkg 并行配置问题
      matrix:
        build-type: [Release, Debug]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        doNotCache: false  # 启用缓存以避免重复构建

    - name: Configure CMake
      env:
        VCPKG_MAX_CONCURRENCY: 1  # 限制 vcpkg 内部并行度
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }} --parallel

    - name: Test
      run: cd build && ctest --build-config ${{ matrix.build-type }} --output-on-failure

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: croupier-cpp-sdk-${{ matrix.build-type }}
        path: |
          build/bin/
          build/lib/

  coverage:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build gcovr

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        doNotCache: false

    - name: Configure CMake (coverage)
      env:
        VCPKG_MAX_CONCURRENCY: 1
      run: |
        cmake -B build-coverage \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_TESTS=ON \
          -DBUILD_EXAMPLES=OFF \
          -DCMAKE_C_FLAGS="--coverage" \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build (coverage)
      run: cmake --build build-coverage --config Debug --parallel

    - name: Test (coverage)
      run: cd build-coverage && ctest --build-config Debug --output-on-failure

    - name: Generate coverage report
      run: |
        gcovr -r . \
          --xml-pretty -o coverage.xml \
          --filter '^(src|include)/' \
          --exclude 'build' \
          --exclude 'build-coverage' \
          --exclude 'vcpkg' \
          --exclude 'tests'

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.xml
        flags: cpp-sdk
        fail_ci_if_error: ${{ github.event_name != 'pull_request' }}
