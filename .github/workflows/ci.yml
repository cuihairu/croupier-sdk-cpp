name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  # Code quality checks (format + static analysis)
  code-quality:
    runs-on: ubuntu-latest
    continue-on-error: true  # 仅警告，不阻止合并

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-17 clang-tidy-17
        sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-17 100
        sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-17 100

    - name: Check code formatting
      run: |
        echo "::group::Checking code formatting with clang-format"
        find src include examples tests -name '*.cpp' -o -name '*.h' | head -100 | while read file; do
          if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
            echo "::warning file=$file::Code formatting issues detected"
          fi
        done
        echo "::endgroup::"

    - name: Run clang-format diff
      run: |
        echo "Files with formatting differences:"
        find src include examples tests -name '*.cpp' -o -name '*.h' | head -100 | xargs -I {} sh -c 'diff -u {} <(clang-format {}) || true' 2>/dev/null | head -200 || true

    - name: Run clang-tidy (basic checks)
      run: |
        echo "::group::Running clang-tidy static analysis"
        # 只检查主要源文件，跳过生成的代码
        for file in src/*.cpp src/**/*.cpp; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
            clang-tidy "$file" \
              --checks='-*,bugprone-*,clang-analyzer-*,performance-*,modernize-use-nullptr,modernize-use-override' \
              --quiet \
              -- -std=c++17 -I include -I src 2>/dev/null || echo "::warning file=$file::clang-tidy found issues"
          fi
        done
        echo "::endgroup::"

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # 允许一个构建失败时其他继续
      max-parallel: 1   # 串行构建避免 vcpkg 并行配置问题
      matrix:
        build-type: [Release, Debug]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
        VCPKG_DEFAULT_TRIPLET: x64-linux
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        doNotCache: false  # 启用缓存以避免重复构建

    - name: Configure CMake
      env:
        VCPKG_MAX_CONCURRENCY: 1  # 限制 vcpkg 内部并行度
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }} --parallel

    - name: Test
      run: cd build && ctest --build-config ${{ matrix.build-type }} --output-on-failure

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: croupier-cpp-sdk-${{ matrix.build-type }}
        path: |
          build/bin/
          build/lib/

  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build-type: [Release, Debug]
        runtime: [static, dynamic]  # static=MT/MTd, dynamic=MD/MDd

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Ninja
      run: choco install ninja -y

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        doNotCache: true  # Windows 上缓存可能不稳定
        extraCacheKeys: ${{ matrix.runtime }}
        # 明确指定 triplet，确保与运行时类型匹配
        triplet: ${{ matrix.runtime == 'static' && 'x64-windows-static' || 'x64-windows-static-md' }}
      env:
        # 防止 VS2022 自带的 vcpkg 干扰我们的 vcpkg 检测
        # 确保 vcpkg 使用我们的实例，而不是 VS2022 自带的副本
        VCPKG_ROOT: '${{ github.workspace }}/vcpkg'

    - name: Configure CMake (Static Runtime)
      if: matrix.runtime == 'static'
      shell: pwsh
      run: |
        $env:CC = ''
        $env:CXX = ''
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static `
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" `
          -DCROUPIER_USE_STATIC_RUNTIME=ON `
          -DBUILD_STATIC_LIBS=ON `
          -DBUILD_SHARED_LIBS=OFF `
          -DBUILD_EXAMPLES=OFF `
          -DBUILD_TESTS=OFF

    - name: Configure CMake (Dynamic Runtime)
      if: matrix.runtime == 'dynamic'
      shell: pwsh
      run: |
        $env:CC = ''
        $env:CXX = ''
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static-md `
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" `
          -DCROUPIER_USE_STATIC_RUNTIME=OFF `
          -DBUILD_STATIC_LIBS=ON `
          -DBUILD_SHARED_LIBS=ON `
          -DBUILD_EXAMPLES=OFF `
          -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }} --parallel

    - name: Prepare artifacts
      shell: pwsh
      run: |
        $runtimeSuffix = if ("${{ matrix.runtime }}" -eq "static") { "mt" } else { "md" }
        $artifactName = "croupier-sdk-windows-x64-${{ matrix.build-type }}-${runtimeSuffix}"

        # 创建输出目录（vcpkg 风格：lib/ 和 debug/lib/）
        New-Item -ItemType Directory -Force -Path "artifacts/$artifactName/include" | Out-Null
        New-Item -ItemType Directory -Force -Path "artifacts/$artifactName/lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "artifacts/$artifactName/debug/lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "artifacts/$artifactName/bin" | Out-Null

        # 复制头文件
        Copy-Item -Path "include/croupier" -Destination "artifacts/$artifactName/include/" -Recurse -Force

        # 复制生成的 proto 头文件（如果存在）
        if (Test-Path "build/include/croupier") {
            Copy-Item -Path "build/include/croupier" -Destination "artifacts/$artifactName/include/" -Recurse -Force
        }

        # 复制 Release 库文件
        if (Test-Path "build/lib/*.lib") {
            Copy-Item -Path "build/lib/*.lib" -Destination "artifacts/$artifactName/lib/" -Force
        }

        # 复制 Debug 库文件（vcpkg 风格：debug/lib/）
        if (Test-Path "build/debug/lib/*.lib") {
            Copy-Item -Path "build/debug/lib/*.lib" -Destination "artifacts/$artifactName/debug/lib/" -Force
        }

        # 复制 DLL 文件
        if (Test-Path "build/bin/*.dll") {
            Copy-Item -Path "build/bin/*.dll" -Destination "artifacts/$artifactName/bin/" -Force
        }
        # Debug DLL
        if (Test-Path "build/debug/bin/*.dll") {
            Copy-Item -Path "build/debug/bin/*.dll" -Destination "artifacts/$artifactName/bin/" -Force
        }

        # 创建 README
        @"
        # Croupier C++ SDK for Windows

        - Build Type: ${{ matrix.build-type }}
        - Runtime: $runtimeSuffix ($(if ("${{ matrix.runtime }}" -eq "static") { "MT/MTd (Static)" } else { "MD/MDd (Dynamic)" }))
        - Architecture: x64

        ## Directory Structure (vcpkg-style)

        ## Usage

        ### Static Library (MT/MTd)
        Add to your project:
        - Additional Include Directories: `path/to/include`
        - Additional Library Directories (Release): `path/to/lib`
        - Additional Library Directories (Debug): `path/to/debug/lib`
        - Additional Dependencies: `croupier-sdk-static.lib`

        ### Dynamic Library (MD/MDd)
        Add to your project:
        - Additional Include Directories: `path/to/include`
        - Additional Library Directories (Release): `path/to/lib`
        - Additional Library Directories (Debug): `path/to/debug/lib`
        - Additional Dependencies: `croupier-sdk.lib`
        - Copy `croupier-sdk.dll` to your executable directory.
        "@ | Out-File -FilePath "artifacts/$artifactName/README.txt" -Encoding UTF8

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: croupier-sdk-windows-x64-${{ matrix.build-type }}-${{ matrix.runtime }}
        path: artifacts/

  coverage:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build gcovr

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        doNotCache: false

    - name: Configure CMake (coverage)
      env:
        VCPKG_MAX_CONCURRENCY: 1
      run: |
        cmake -B build-coverage \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_TESTS=ON \
          -DBUILD_EXAMPLES=OFF \
          -DCMAKE_C_FLAGS="--coverage" \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

    - name: Build (coverage)
      run: cmake --build build-coverage --config Debug --parallel

    - name: Test (coverage)
      run: cd build-coverage && ctest --build-config Debug --output-on-failure

    - name: Generate coverage report
      run: |
        gcovr -r . \
          --xml-pretty -o coverage.xml \
          --filter '^(src|include)/' \
          --exclude 'build' \
          --exclude 'build-coverage' \
          --exclude 'vcpkg' \
          --exclude 'tests'

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.xml
        flags: cpp-sdk
        fail_ci_if_error: ${{ github.event_name != 'pull_request' }}

  lua-binding:
    name: Lua Binding Test
    if: false  # TEMPORARILY DISABLED: Lua binding feature not yet implemented
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build lua5.5 liblua5.5-dev || sudo apt-get install -y lua5.4 liblua5.4-dev

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgConfigurationArgs: '--feature lua'

    - name: Configure CMake with Lua binding
      env:
        VCPKG_MAX_CONCURRENCY: 1
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=OFF \
          -DBUILD_TESTS=ON \
          -DENABLE_LUA_BINDING=ON

    - name: Build
      run: cmake --build build --config Release --parallel

    - name: Test Lua binding (basic)
      run: |
        # Create a simple Lua test script
        cat > test_lua.lua << 'EOF'
        -- Basic Lua binding test
        package.cpath = package.cpath .. ";./build/lib/?.so"
        local croupier = require("croupier")

        -- Test client creation
        local client, err = pcall(function()
          return croupier.Client.new("localhost:50051")
        end)

        if client then
          print("✓ Lua binding: Client creation successful")
          print("✓ Lua binding: Module loaded correctly")
          return 0
        else
          print("✗ Lua binding: Client creation failed")
          print("Error:", err)
          return 1
        end
        EOF

        lua5.5 test_lua.lua || lua5.4 test_lua.lua

    - name: Test Lua binding examples
      run: |
        if [ -f "lua/examples/standalone_example.lua" ]; then
          echo "Testing Lua example file..."
          lua5.5 -e "dofile('lua/examples/standalone_example.lua')" || lua5.4 -e "dofile('lua/examples/standalone_example.lua')" || echo "Example test may require server connection"
        fi

    - name: Upload Lua artifacts
      uses: actions/upload-artifact@v4
      with:
        name: croupier-sdk-lua-binding
        path: |
          build/lib/libcroupier-sdk.so*
          lua/
          skynet/

  skynet-so:
    name: Skynet .so Build Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build lua5.5 liblua5.5-dev || sudo apt-get install -y lua5.4 liblua5.4-dev git

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      env:
        VCPKG_FORCE_SYSTEM_BINARIES: 1
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: '594ad8871e1e8e45f8e626c015fd611163430207'
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgConfigurationArgs: '--feature lua'

    - name: Clone Skynet
      run: |
        cd /tmp
        git clone https://github.com/cloudwu/skynet.git
        cd skynet
        # Use a stable tag
        git checkout tags/${SKYNET_VERSION} 2>/dev/null || echo "Using default branch"

    - name: Configure CMake for Skynet .so
      env:
        VCPKG_MAX_CONCURRENCY: 1
        SKYNET_VERSION: "5.0"
      run: |
        cmake -B build-skynet \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
          -DVCPKG_OVERLAY_PORTS="${{ github.workspace }}/vcpkg-overlays" \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=OFF \
          -DBUILD_TESTS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DENABLE_LUA_BINDING=ON \
          -DCROUPIER_SKYNET_SO=ON

    - name: Build Skynet .so
      run: cmake --build build-skynet --config Release --parallel

    - name: Verify Skynet service files
      run: |
        echo "Checking Skynet service files..."
        if [ -f "skynet/service/croupier_service.lua" ]; then
          echo "✓ Skynet service file found"
          head -20 skynet/service/croupier_service.lua
        else
          echo "✗ Skynet service file not found"
          exit 1
        fi

    - name: Create Skynet integration package
      run: |
        mkdir -p skynet-package/cservice
        mkdir -p skynet-package/lua
        mkdir -p skynet-package/examples

        # Copy the .so file (Skynet C service)
        if [ -f "build-skynet/lib/libcroupier-sdk.so" ]; then
          cp build-skynet/lib/libcroupier-sdk.so skynet-package/cservice/
          echo "✓ Copied libcroupier-sdk.so to cservice/"
        fi

        # Copy Lua bindings
        if [ -d "lua" ]; then
          cp -r lua/* skynet-package/lua/
          echo "✓ Copied Lua bindings"
        fi

        # Copy Skynet service
        if [ -f "skynet/service/croupier_service.lua" ]; then
          cp skynet/service/croupier_service.lua skynet-package/lua/
          echo "✓ Copied croupier_service.lua"
        fi

        # Copy examples
        if [ -d "skynet/examples" ]; then
          cp -r skynet/examples/* skynet-package/examples/
          echo "✓ Copied Skynet examples"
        fi

        # Create README
        cat > skynet-package/README.md << 'EOF'
        # Croupier SDK for Skynet

        This package contains the Croupier C++ SDK compiled as a Skynet C service (.so).

        ## Installation

        1. Copy `libcroupier-sdk.so` to your Skynet project's `cservice/` directory
        2. Copy all files from `lua/` to your Skynet project's `lua/` directory
        3. Use the service in your Skynet configuration

        ## Usage

        See `examples/` for complete examples.

        ```lua
        local skynet = require "skynet"
        local croupier = require "croupier"

        -- Start Croupier service
        skynet.call(".croupier", "lua", "start", "localhost:50051")

        -- Register a virtual object
        skynet.call(".croupier", "lua", "register_vo", "player_001", "Player", {
          level = 10,
          name = "TestPlayer"
        })
        ```
        EOF

        echo "Skynet package created successfully"

    - name: Upload Skynet artifacts
      uses: actions/upload-artifact@v4
      with:
        name: croupier-sdk-skynet-so
        path: skynet-package/
