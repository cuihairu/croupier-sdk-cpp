cmake_minimum_required(VERSION 3.20)

project(croupier-cpp-sdk
    VERSION 1.0.0
    DESCRIPTION "Croupier C++ SDK for Game Function Registration"
    LANGUAGES CXX
)

# ========== Project Configuration ==========
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ========== Build Options ==========
option(BUILD_SHARED_LIBS "Build shared libraries" ON)
option(BUILD_STATIC_LIBS "Build static libraries" ON)
option(BUILD_EXAMPLES "Build example programs" ON)
option(BUILD_TESTS "Build unit tests" OFF)
option(ENABLE_GRPC "Enable real gRPC implementation" ON)

# ========== vcpkg ä¼˜åŒ–é…ç½® ==========
option(USE_SYSTEM_PACKAGES "Use system packages instead of vcpkg for common libraries" OFF)
option(VCPKG_RELEASE_ONLY "Use release-only vcpkg triplet to avoid Debug/Release duplication" ON)

# è‡ªåŠ¨æ£€æµ‹æœ€ä¼˜çš„ä¾èµ–å®‰è£…ç­–ç•¥
if(NOT DEFINED CMAKE_TOOLCHAIN_FILE)
    # å°è¯•æ£€æµ‹ç³»ç»ŸåŒ…
    if(USE_SYSTEM_PACKAGES OR NOT DEFINED ENV{VCPKG_ROOT})
        message(STATUS "Attempting to use system packages...")
        set(USE_SYSTEM_DEPS ON)
    else()
        message(STATUS "Using vcpkg packages...")
        set(USE_SYSTEM_DEPS OFF)

        # ä¼˜åŒ– vcpkg é…ç½®
        set(CMAKE_TOOLCHAIN_FILE "$ENV{VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
            CACHE STRING "Vcpkg toolchain file")

        # ä½¿ç”¨ release-only triplet é¿å…é‡å¤ç¼–è¯‘
        if(VCPKG_RELEASE_ONLY AND NOT VCPKG_TARGET_TRIPLET)
            if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
                set(VCPKG_TARGET_TRIPLET "x64-windows-release")
            elseif(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
                if(CMAKE_SYSTEM_PROCESSOR STREQUAL "arm64")
                    set(VCPKG_TARGET_TRIPLET "arm64-osx-release")
                else()
                    set(VCPKG_TARGET_TRIPLET "x64-osx-release")
                endif()
            else() # Linux
                if(CMAKE_SYSTEM_PROCESSOR STREQUAL "aarch64")
                    set(VCPKG_TARGET_TRIPLET "arm64-linux-release")
                else()
                    set(VCPKG_TARGET_TRIPLET "x64-linux-release")
                endif()
            endif()

            message(STATUS "Using release-only vcpkg triplet: ${VCPKG_TARGET_TRIPLET}")
            message(STATUS "This saves ~50% build time by avoiding Debug lib compilation")
        endif()
    endif()
endif()

# ========== æ£€æŸ¥é¢„ç”Ÿæˆçš„ Proto æ–‡ä»¶ ==========
set(GENERATED_PROTO_DIR ${CMAKE_CURRENT_SOURCE_DIR}/generated)

if(ENABLE_GRPC)
    if(NOT EXISTS ${GENERATED_PROTO_DIR}/croupier)
        message(WARNING "Generated proto files not found!")
        message(WARNING "Run: scripts/sync-sdk-generated.sh to sync files")
        message(WARNING "Falling back to mock implementation...")
        set(ENABLE_GRPC OFF)
        set(USE_SYSTEM_DEPS ON)  # æ— gRPCæ—¶ä½¿ç”¨ç³»ç»ŸåŒ…æ›´ç®€å•
    else()
        file(GLOB_RECURSE GENERATED_SOURCES "${GENERATED_PROTO_DIR}/**/*.cc")
        file(GLOB_RECURSE GENERATED_HEADERS "${GENERATED_PROTO_DIR}/**/*.h")
        list(LENGTH GENERATED_SOURCES SOURCE_COUNT)
        list(LENGTH GENERATED_HEADERS HEADER_COUNT)
        message(STATUS "Found ${SOURCE_COUNT} generated sources, ${HEADER_COUNT} headers")
    endif()
endif()

# ========== ä¾èµ–ç®¡ç†ï¼šç³»ç»ŸåŒ… vs vcpkg ==========
find_package(Threads REQUIRED)

if(ENABLE_GRPC)
    if(USE_SYSTEM_DEPS)
        # æ–¹æ¡ˆ1: ä½¿ç”¨ç³»ç»ŸåŒ…ï¼ˆæ¨èç”¨äº CIï¼‰
        message(STATUS "Attempting to use system gRPC packages...")

        # Ubuntu/Debian
        find_package(PkgConfig QUIET)
        if(PkgConfig_FOUND)
            pkg_check_modules(GRPC QUIET grpc++)
            pkg_check_modules(PROTOBUF QUIET protobuf)
        endif()

        # å›é€€åˆ° find_package
        if(NOT GRPC_FOUND)
            find_package(gRPC CONFIG QUIET)
            find_package(Protobuf CONFIG QUIET)
        endif()

        if(gRPC_FOUND OR GRPC_FOUND)
            message(STATUS "âœ… Found system gRPC packages")
            if(gRPC_FOUND)
                set(GRPC_LIBRARIES gRPC::grpc++ gRPC::grpc++_reflection protobuf::libprotobuf)
            else()
                set(GRPC_LIBRARIES ${GRPC_LIBRARIES} ${PROTOBUF_LIBRARIES})
            endif()
        else()
            message(WARNING "âŒ System gRPC not found, disabling gRPC support")
            message(STATUS "Install with: apt-get install libgrpc++-dev libprotobuf-dev")
            set(ENABLE_GRPC OFF)
        endif()
    else()
        # æ–¹æ¡ˆ2: ä½¿ç”¨ vcpkgï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        message(STATUS "Using vcpkg gRPC packages...")
        find_package(gRPC CONFIG REQUIRED)
        find_package(Protobuf CONFIG REQUIRED)

        message(STATUS "âœ… Found vcpkg gRPC: ${gRPC_VERSION}")
        message(STATUS "âœ… Found vcpkg Protobuf: ${Protobuf_VERSION}")

        set(GRPC_LIBRARIES gRPC::grpc++ gRPC::grpc++_reflection protobuf::libprotobuf)
    endif()
endif()

# JSON åº“ï¼šä¼˜å…ˆä½¿ç”¨ç³»ç»ŸåŒ…
if(USE_SYSTEM_DEPS)
    find_package(PkgConfig QUIET)
    if(PkgConfig_FOUND)
        pkg_check_modules(NLOHMANN_JSON QUIET nlohmann_json)
        if(NLOHMANN_JSON_FOUND)
            message(STATUS "âœ… Found system nlohmann_json")
            set(JSON_LIBRARY PkgConfig::NLOHMANN_JSON)
        endif()
    endif()

    # Ubuntu header-only åŒ…
    if(NOT NLOHMANN_JSON_FOUND)
        find_path(NLOHMANN_JSON_INCLUDE_DIR nlohmann/json.hpp)
        if(NLOHMANN_JSON_INCLUDE_DIR)
            message(STATUS "âœ… Found system nlohmann_json headers")
            add_library(nlohmann_json_system INTERFACE)
            target_include_directories(nlohmann_json_system INTERFACE ${NLOHMANN_JSON_INCLUDE_DIR})
            set(JSON_LIBRARY nlohmann_json_system)
        endif()
    endif()
else()
    find_package(nlohmann_json CONFIG QUIET)
    if(nlohmann_json_FOUND)
        message(STATUS "âœ… Found vcpkg nlohmann_json: ${nlohmann_json_VERSION}")
        set(JSON_LIBRARY nlohmann_json::nlohmann_json)
    endif()
endif()

# ========== ç¼–è¯‘é€‰é¡¹ ==========
if(MSVC)
    add_compile_options(/W4)
    add_compile_definitions(_CRT_SECURE_NO_WARNINGS)
    # ç§»é™¤ /WXï¼Œé¿å…ç¬¬ä¸‰æ–¹åº“è­¦å‘Šå¯¼è‡´ç¼–è¯‘å¤±è´¥
else()
    add_compile_options(-Wall -Wextra)
    # ç§»é™¤ -Werrorï¼ŒåŒæ ·é¿å…ç¬¬ä¸‰æ–¹åº“è­¦å‘Š
    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        add_compile_options(-g -O3)
    endif()
endif()

# ========== æºæ–‡ä»¶ ==========
set(SDK_SOURCES
    src/croupier_client.cpp
    src/grpc_service.cpp
    src/config_driven_loader.cpp
    src/utils/json_utils.cpp
    src/utils/file_utils.cpp
    src/config/client_config_loader.cpp
    src/plugin/dynamic_loader.cpp
)

set(SDK_HEADERS
    include/croupier/sdk/croupier_client.h
    include/croupier/sdk/grpc_service.h
    include/croupier/sdk/config_driven_loader.h
    include/croupier/sdk/utils/json_utils.h
    include/croupier/sdk/utils/file_utils.h
    include/croupier/sdk/config/client_config_loader.h
    include/croupier/sdk/plugin/dynamic_loader.h
)

# æ¡ä»¶æ·»åŠ ç”Ÿæˆçš„protoæ–‡ä»¶
if(ENABLE_GRPC AND GENERATED_SOURCES)
    list(APPEND SDK_SOURCES ${GENERATED_SOURCES})
    list(APPEND SDK_HEADERS ${GENERATED_HEADERS})
    message(STATUS "âœ… Added ${SOURCE_COUNT} proto sources to build")
endif()

# ========== åº“ç›®æ ‡é€šç”¨è®¾ç½® ==========
function(setup_sdk_target target_name target_type)
    # åŒ…å«ç›®å½•
    target_include_directories(${target_name}
        PUBLIC
            $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
            $<INSTALL_INTERFACE:include>
        PRIVATE
            $<$<BOOL:${ENABLE_GRPC}>:${GENERATED_PROTO_DIR}>
    )

    # åŸºç¡€ä¾èµ–
    target_link_libraries(${target_name} PUBLIC Threads::Threads)

    # gRPC æ”¯æŒ
    if(ENABLE_GRPC AND GRPC_LIBRARIES)
        target_link_libraries(${target_name} PUBLIC ${GRPC_LIBRARIES})
        target_compile_definitions(${target_name} PUBLIC CROUPIER_SDK_ENABLE_GRPC)
    endif()

    # JSON æ”¯æŒ
    if(JSON_LIBRARY)
        target_link_libraries(${target_name} PUBLIC ${JSON_LIBRARY})
        target_compile_definitions(${target_name} PUBLIC CROUPIER_SDK_ENABLE_JSON)
    endif()

    # åº“ç±»å‹å®šä¹‰
    if(target_type STREQUAL "SHARED")
        target_compile_definitions(${target_name}
            PRIVATE CROUPIER_SDK_BUILDING_DLL
            PUBLIC CROUPIER_SDK_SHARED
        )
        set_target_properties(${target_name} PROPERTIES
            OUTPUT_NAME "croupier-sdk"
            VERSION ${PROJECT_VERSION}
            SOVERSION ${PROJECT_VERSION_MAJOR}
        )
    else()
        target_compile_definitions(${target_name} PUBLIC CROUPIER_SDK_STATIC)
        set_target_properties(${target_name} PROPERTIES
            OUTPUT_NAME "croupier-sdk-static"
        )
    endif()
endfunction()

# ========== æ„å»ºç›®æ ‡ ==========
if(BUILD_SHARED_LIBS)
    add_library(croupier-sdk-shared SHARED ${SDK_SOURCES} ${SDK_HEADERS})
    setup_sdk_target(croupier-sdk-shared "SHARED")
    add_library(croupier::sdk-shared ALIAS croupier-sdk-shared)
endif()

if(BUILD_STATIC_LIBS)
    add_library(croupier-sdk-static STATIC ${SDK_SOURCES} ${SDK_HEADERS})
    setup_sdk_target(croupier-sdk-static "STATIC")
    add_library(croupier::sdk-static ALIAS croupier-sdk-static)
endif()

# é»˜è®¤ç›®æ ‡
if(BUILD_SHARED_LIBS)
    add_library(croupier::sdk ALIAS croupier-sdk-shared)
elseif(BUILD_STATIC_LIBS)
    add_library(croupier::sdk ALIAS croupier-sdk-static)
endif()

# ========== ç¤ºä¾‹ç¨‹åº ==========
if(BUILD_EXAMPLES)
    foreach(example IN ITEMS example virtual_object_demo complete_example config_example plugin_demo comprehensive_demo)
        add_executable(croupier-${example} examples/${example}.cpp)
        target_link_libraries(croupier-${example} PRIVATE croupier::sdk)
        set_target_properties(croupier-${example} PROPERTIES
            RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        )
    endforeach()

    # ç¤ºä¾‹æ’ä»¶
    add_library(example_plugin SHARED examples/plugins/example_plugin.cpp)
    target_include_directories(example_plugin PRIVATE include)
    set_target_properties(example_plugin PROPERTIES
        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/plugins
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/plugins
    )
endif()

# ========== å•å…ƒæµ‹è¯• ==========
if(BUILD_TESTS)
    enable_testing()
    find_package(GTest CONFIG)

    if(GTest_FOUND)
        add_executable(croupier-sdk-tests
            tests/test_virtual_objects.cpp
            tests/test_utils.cpp
            tests/test_integration.cpp
        )
        target_link_libraries(croupier-sdk-tests PRIVATE croupier::sdk GTest::gtest_main)
        add_test(NAME CroupierSDKTests COMMAND croupier-sdk-tests)
    endif()
endif()

# ========== æ„å»ºæ‘˜è¦ ==========
message(STATUS "")
message(STATUS "ğŸ¯ ========== Croupier C++ SDK Build Summary ==========")
message(STATUS "ğŸ“¦ Project:         ${PROJECT_NAME} v${PROJECT_VERSION}")
message(STATUS "ğŸ”§ Build Type:      ${CMAKE_BUILD_TYPE}")
message(STATUS "ğŸ“„ C++ Standard:    ${CMAKE_CXX_STANDARD}")
message(STATUS "")
message(STATUS "ğŸš€ Features:")
message(STATUS "   ğŸ“¡ gRPC Support:   ${ENABLE_GRPC}")
if(ENABLE_GRPC)
message(STATUS "   ğŸ“ Proto Sources:  ${SOURCE_COUNT} files")
endif()
message(STATUS "   ğŸ”— JSON Support:   ${JSON_LIBRARY}")
message(STATUS "   ğŸ“š Shared Library: ${BUILD_SHARED_LIBS}")
message(STATUS "   ğŸ“˜ Static Library: ${BUILD_STATIC_LIBS}")
message(STATUS "   ğŸ® Examples:       ${BUILD_EXAMPLES}")
message(STATUS "   ğŸ§ª Tests:          ${BUILD_TESTS}")
message(STATUS "")
message(STATUS "âš¡ Dependency Strategy:")
if(USE_SYSTEM_DEPS)
message(STATUS "   ğŸ“¦ Using system packages (faster CI builds)")
else()
message(STATUS "   ğŸ› ï¸  Using vcpkg packages (consistent dev environment)")
if(VCPKG_RELEASE_ONLY)
message(STATUS "   ğŸ¯ Release-only triplet: ${VCPKG_TARGET_TRIPLET}")
message(STATUS "   ğŸ’° This saves ~50% build time & cost")
endif()
endif()
message(STATUS "==================================================")
message(STATUS "")